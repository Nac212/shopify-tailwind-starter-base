{% doc %}
  @prompt
    Create a scrollable product carousel section for a Shopify page.
    
    The section should have a customizable heading (e.g., "TRENDING PIECES") with a customizable font and color.
    
    The carousel should display a maximum of four product cards at a time on desktop and be fully scrollable on all devices. Include a dot or line-based pagination system below the product cards to indicate progress through the carousel.
    
    The product cards should have a customizable amount of white space between them. Each card should display the product image, title, and price. When a product is on sale, it should show both the original and sale price, with the sale price in a different color. A small, customizable "ON SALE" badge should be displayed on the product image.
    
    The section should include settings for a store owner to:
    
    Choose a specific collection to pull products from.
    
    Alternatively, manually select individual products to display.
    
    Customize the font and size of the section heading.
    
    Customize the font and size of the product titles.
    
    Customize the amount of white space between the product cards.
    
    Ensure the section is fully responsive and functions correctly on both desktop and mobile devices., please make Poppins compatible with the product title and price. Try and make as many fonts as possible compatible with this section

{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% liquid
  if block.settings.product_source == 'collection' and block.settings.collection != blank
    assign products = block.settings.collection.products
  else
    assign products = block.settings.manual_products
  endif
%}

{% style %}
  .ai-product-carousel-{{ ai_gen_id }} {
    padding: 40px 20px;
  }

  .ai-product-carousel__heading-{{ ai_gen_id }} {
    text-align: center;
    margin: 0 0 40px;
    font-family: {{ block.settings.heading_font.family }}, {{ block.settings.heading_font.fallback_families }};
    font-weight: {{ block.settings.heading_font.weight }};
    font-style: {{ block.settings.heading_font.style }};
    font-size: {{ block.settings.heading_size }}px;
    color: {{ block.settings.heading_color }};
  }

  .ai-product-carousel__container-{{ ai_gen_id }} {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
  }

  .ai-product-carousel__track-wrapper-{{ ai_gen_id }} {
    overflow: hidden;
    border-radius: 8px;
  }

  .ai-product-carousel__track-{{ ai_gen_id }} {
    display: flex;
    transition: transform 0.3s ease;
    gap: {{ block.settings.card_spacing }}px;
  }

  .ai-product-carousel__card-{{ ai_gen_id }} {
    flex: 0 0 calc((100% - {{ block.settings.card_spacing | times: 3 }}px) / 4);
    position: relative;
  }

  .ai-product-carousel__image-wrapper-{{ ai_gen_id }} {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .ai-product-carousel__image-{{ ai_gen_id }} {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .ai-product-carousel__card-{{ ai_gen_id }}:hover .ai-product-carousel__image-{{ ai_gen_id }} {
    transform: scale(1.05);
  }

  .ai-product-carousel__image-placeholder-{{ ai_gen_id }} {
    width: 100%;
    height: 100%;
    background-color: #f4f4f4;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
  }

  .ai-product-carousel__image-placeholder-{{ ai_gen_id }} svg {
    width: 60%;
    height: 60%;
    opacity: 0.3;
  }

  .ai-product-carousel__badge-{{ ai_gen_id }} {
    position: absolute;
    top: 8px;
    left: 8px;
    background-color: {{ block.settings.sale_badge_color }};
    color: {{ block.settings.sale_badge_text_color }};
    padding: 4px 8px;
    border-radius: {{ block.settings.sale_badge_radius }}px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    z-index: 2;
  }

  .ai-product-carousel__title-{{ ai_gen_id }} {
    font-family: {{ block.settings.product_title_font.family }}, {{ block.settings.product_title_font.fallback_families }};
    font-weight: {{ block.settings.product_title_font.weight }};
    font-style: {{ block.settings.product_title_font.style }};
    font-size: {{ block.settings.product_title_size }}px;
    color: {{ block.settings.product_title_color }};
    margin: 0 0 8px;line-height: 1.3;
  }

  .ai-product-carousel__title-link-{{ ai_gen_id }} {
    text-decoration: none;
    color: inherit;
  }

  .ai-product-carousel__title-link-{{ ai_gen_id }}:hover {
    text-decoration: underline;
  }

  .ai-product-carousel__price-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: {{ block.settings.price_font.family }}, {{ block.settings.price_font.fallback_families }};
    font-weight: {{ block.settings.price_font.weight }};
    font-style: {{ block.settings.price_font.style }};
    font-size: {{ block.settings.price_size }}px;
  }

  .ai-product-carousel__price-current-{{ ai_gen_id }} {
    color: {{ block.settings.sale_price_color }};
    font-weight: 600;
  }

  .ai-product-carousel__price-original-{{ ai_gen_id }} {
    color: {{ block.settings.original_price_color }};
    text-decoration: line-through;
    opacity: 0.7;
  }

  .ai-product-carousel__pagination-{{ ai_gen_id }} {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 30px;
  }

  .ai-product-carousel__dot-{{ ai_gen_id }} {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: {{ block.settings.pagination_inactive_color }};
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.3s ease;
  }

  .ai-product-carousel__dot-{{ ai_gen_id }}.active {
    background-color: {{ block.settings.pagination_active_color }};
    transform: scale(1.2);
  }

  .ai-product-carousel__empty-state-{{ ai_gen_id }} {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .ai-product-carousel__empty-state-{{ ai_gen_id }} h3 {
    margin: 0 0 8px;
    font-size: 18px;
  }

  .ai-product-carousel__empty-state-{{ ai_gen_id }} p {
    margin: 0;
    font-size: 14px;
    opacity: 0.8;
  }

  @media screen and (max-width: 990px) {
    .ai-product-carousel__card-{{ ai_gen_id }} {
      flex: 0 0 calc((100% - {{ block.settings.card_spacing | times: 2 }}px) / 3);
    }
  }

  @media screen and (max-width: 749px) {
    .ai-product-carousel-{{ ai_gen_id }} {
      padding: 30px 15px;
    }

    .ai-product-carousel__heading-{{ ai_gen_id }} {
      font-size: {{ block.settings.heading_size | times: 0.8 }}px;
      margin-bottom: 30px;
    }

    .ai-product-carousel__card-{{ ai_gen_id }} {
      flex: 0 0 calc((100% - {{ block.settings.card_spacing }}px) / 2);
    }

    .ai-product-carousel__title-{{ ai_gen_id }} {
      font-size: {{ block.settings.product_title_size | times: 0.9 }}px;
    }

    .ai-product-carousel__price-{{ ai_gen_id }} {
      font-size: {{ block.settings.price_size | times: 0.9 }}px;
    }
  }

  @media screen and (max-width: 480px) {
    .ai-product-carousel__card-{{ ai_gen_id }} {
      flex: 0 0 100%;
    }
  }
{% endstyle %}

<product-carousel-{{ ai_gen_id }} class="ai-product-carousel-{{ ai_gen_id }}" {{ block.shopify_attributes }}>
  {% if block.settings.heading != blank %}
    <h2 class="ai-product-carousel__heading-{{ ai_gen_id }}">{{ block.settings.heading }}</h2>
  {% endif %}

  {% if products.size > 0 %}
    <div class="ai-product-carousel__container-{{ ai_gen_id }}">
      <div class="ai-product-carousel__track-wrapper-{{ ai_gen_id }}">
        <div class="ai-product-carousel__track-{{ ai_gen_id }}" data-track>
          {% for product in products limit: 12 %}
            <div class="ai-product-carousel__card-{{ ai_gen_id }}">
              <div class="ai-product-carousel__image-wrapper-{{ ai_gen_id }}">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 400 }}"
                    alt="{{ product.featured_image.alt | escape }}"
                    class="ai-product-carousel__image-{{ ai_gen_id }}"
                    loading="lazy"
                    width="400"
                    height="400"
                  >
                {% else %}
                  <div class="ai-product-carousel__image-placeholder-{{ ai_gen_id }}">
                    {{ 'product-1' | placeholder_svg_tag }}
                  </div>
                {% endif %}

                {% if product.compare_at_price > product.price %}
                  <div class="ai-product-carousel__badge-{{ ai_gen_id }}">
                    {{ block.settings.sale_badge_text }}
                  </div>
                {% endif %}
              </div>

              <h3 class="ai-product-carousel__title-{{ ai_gen_id }}">
                <a href="{{ product.url }}" class="ai-product-carousel__title-link-{{ ai_gen_id }}">
                  {{ product.title }}
                </a>
              </h3>

              <div class="ai-product-carousel__price-{{ ai_gen_id }}">
                {% if product.compare_at_price > product.price %}
                  <span class="ai-product-carousel__price-current-{{ ai_gen_id }}">
                    {{ product.price | money }}
                  </span>
                  <span class="ai-product-carousel__price-original-{{ ai_gen_id }}">
                    {{ product.compare_at_price | money }}
                  </span>
                {% else %}
                  <span class="ai-product-carousel__price-current-{{ ai_gen_id }}">
                    {{ product.price | money }}
                  </span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      {% if products.size > 4 %}
        <div class="ai-product-carousel__pagination-{{ ai_gen_id }}" data-pagination></div>
      {% endif %}
    </div>
  {% else %}
    <div class="ai-product-carousel__empty-state-{{ ai_gen_id }}">
      <h3>No products to display</h3>
      <p>
        {% if block.settings.product_source == 'collection' %}
          Select a collection or choose manual product selection
        {% else %}
          Add products to display in this carousel
        {% endif %}
      </p>
    </div>
  {% endif %}
</product-carousel-{{ ai_gen_id }}>

<script>
  (function() {
    class ProductCarousel{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.currentIndex = 0;
        this.itemsPerView = 4;
        this.totalItems = 0;
      }

      connectedCallback() {
        this.track = this.querySelector('[data-track]');
        this.pagination = this.querySelector('[data-pagination]');
        
        if (!this.track) return;

        this.cards = this.track.querySelectorAll('.ai-product-carousel__card-{{ ai_gen_id }}');
        this.totalItems = this.cards.length;

        this.updateItemsPerView();
        this.setupPagination();
        this.setupEventListeners();
        this.updateCarousel();
      }

      updateItemsPerView() {
        const width = window.innerWidth;
        if (width <= 480) {
          this.itemsPerView = 1;
        } else if (width <= 749) {
          this.itemsPerView = 2;
        } else if (width <= 990) {
          this.itemsPerView = 3;
        } else {
          this.itemsPerView = 4;
        }
      }

      setupPagination() {
        if (!this.pagination || this.totalItems <= this.itemsPerView) return;

        this.totalPages = Math.ceil(this.totalItems - this.itemsPerView + 1);
        this.pagination.innerHTML = '';

        for (let i = 0; i < this.totalPages; i++) {
          const dot = document.createElement('button');
          dot.className = `ai-product-carousel__dot-{{ ai_gen_id }}`;
          dot.setAttribute('data-index', i);
          dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
          if (i === 0) dot.classList.add('active');
          this.pagination.appendChild(dot);
        }
      }

      setupEventListeners() {
        if (this.pagination) {
          this.pagination.addEventListener('click', (e) => {
            const dot = e.target.closest('.ai-product-carousel__dot-{{ ai_gen_id }}');
            if (dot) {
              this.currentIndex = parseInt(dot.getAttribute('data-index'));
              this.updateCarousel();
            }
          });
        }

        window.addEventListener('resize', () => {
          this.updateItemsPerView();
          this.setupPagination();
          this.currentIndex = Math.min(this.currentIndex, Math.max(0, this.totalItems - this.itemsPerView));
          this.updateCarousel();
        });

        let startX = 0;
        let currentX = 0;
        let isDragging = false;

        this.track.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
          isDragging = true;
        });

        this.track.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          currentX = e.touches[0].clientX;
        });

        this.track.addEventListener('touchend', () => {
          if (!isDragging) return;
          isDragging = false;

          const diff = startX - currentX;
          const threshold = 50;

          if (Math.abs(diff) > threshold) {
            if (diff > 0 && this.currentIndex < this.totalItems - this.itemsPerView) {
              this.currentIndex++;
            } else if (diff < 0 && this.currentIndex > 0) {
              this.currentIndex--;
            }
            this.updateCarousel();
          }
        });
      }

      updateCarousel() {
        if (!this.track) return;

        const cardWidth = 100 / this.itemsPerView;
        const translateX = -(this.currentIndex * cardWidth);
        this.track.style.transform = `translateX(${translateX}%)`;

        if (this.pagination) {
          const dots = this.pagination.querySelectorAll('.ai-product-carousel__dot-{{ ai_gen_id }}');
          dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === this.currentIndex);
          });
        }
      }
    }

    customElements.define('product-carousel-{{ ai_gen_id }}', ProductCarousel{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Product carousel",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "TRENDING PIECES"
    },
    {
      "type": "select",
      "id": "product_source",
      "label": "Product source",
      "options": [
        {
          "value": "collection",
          "label": "Collection"
        },
        {
          "value": "manual",
          "label": "Manual selection"
        }
      ],
      "default": "collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "product_list",
      "id": "manual_products",
      "label": "Products",
      "limit": 12
    },
    {
      "type": "header",
      "content": "Heading style"
    },
    {
      "type": "font_picker",
      "id": "heading_font",
      "label": "Font",
      "default": "poppins_n4"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 16,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Size",
      "default": 32
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Product cards"
    },
    {
      "type": "range",
      "id": "card_spacing",
      "min": 8,
      "max": 40,
      "step": 4,
      "unit": "px",
      "label": "Spacing between cards",
      "default": 16
    },
    {
      "type": "font_picker",
      "id": "product_title_font",
      "label": "Product title font",
      "default": "poppins_n4"
    },
    {
      "type": "range",
      "id": "product_title_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Product title size",
      "default": 16
    },
    {
      "type": "color",
      "id": "product_title_color",
      "label": "Product title color",
      "default": "#000000"
    },
    {
      "type": "font_picker",
      "id": "price_font",
      "label": "Price font",
      "default": "poppins_n4"
    },
    {
      "type": "range",
      "id": "price_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Price size",
      "default": 14
    },
    {
      "type": "color",
      "id": "sale_price_color",
      "label": "Sale price color",
      "default": "#d12c2c"
    },
    {
      "type": "color",
      "id": "original_price_color",
      "label": "Original price color",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Sale badge"
    },
    {
      "type": "text",
      "id": "sale_badge_text",
      "label": "Badge text",
      "default": "ON SALE"
    },
    {
      "type": "color",
      "id": "sale_badge_color",
      "label": "Background color",
      "default": "#d12c2c"
    },
    {
      "type": "color",
      "id": "sale_badge_text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "sale_badge_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Border radius",
      "default": 4
    },
    {
      "type": "header",
      "content": "Pagination"
    },
    {
      "type": "color",
      "id": "pagination_active_color",
      "label": "Active dot color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "pagination_inactive_color",
      "label": "Inactive dot color",
      "default": "#cccccc"
    }
  ],
  "presets": [
    {
      "name": "Product carousel"
    }
  ]
}
{% endschema %}