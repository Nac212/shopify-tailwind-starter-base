{% comment %}
  Shopify section code - Final Version by Gemini.
  - Replaced the entire "Custom Element" script with a more robust, direct JavaScript approach.
  - The new script uses getElementById to reliably find the section and its components,
    bypassing the Shopify theme editor's script execution issues.
  - This resolves the unresponsive arrow buttons.
  - Restored the original CSS for the arrow icon size.
{% endcomment %}

{% style %}
  .ai-product-carousel-{{ section.id }} {
    width: 100%;
    padding: {{ section.settings.section_padding_top }}px 20px {{ section.settings.section_padding_bottom }}px 20px;
    box-sizing: border-box;
  }

  .ai-product-carousel__header-{{ section.id }} {
    display: flex;
    justify-content: {% if section.settings.heading_center %}center{% else %}flex-start{% endif %};
    align-items: center;
    gap: 20px;
    margin: 0 0 30px 0;
  }

  .ai-product-carousel__heading-{{ section.id }} {
    font-family: {{ section.settings.heading_font.family }}, {{ section.settings.heading_font.fallback_families }};
    font-weight: {{ section.settings.heading_font.weight }};
    font-style: {{ section.settings.heading_font.style }};
    font-size: {{ section.settings.heading_size }}px;
    color: {{ section.settings.heading_color }};
    margin: 0;
    flex-grow: 0;
    white-space: nowrap;
  }

  .ai-product-carousel__container-{{ section.id }} {
    position: relative;
    width: 100%;
  }

  .ai-product-carousel__track-wrapper-{{ section.id }} {
    position: relative;
  }

  .ai-product-carousel__side-arrow-{{ section.id }} {
    display: none; /* Hidden by default, shown on desktop */
  }

  .ai-product-carousel__track-{{ section.id }} {
    display: flex;
    gap: {{ section.settings.card_spacing }}px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 20px;
    scroll-behavior: smooth;
  }

  .ai-product-carousel__track-{{ section.id }}::-webkit-scrollbar {
    display: none;
  }

  .ai-product-carousel__card-{{ section.id }} {
    flex: 0 0 auto;
    width: calc((100% - ({{ section.settings.card_spacing }}px * 4)) / 4.3);
    min-width: 200px;
  }

  .ai-product-carousel__image-container-{{ section.id }} {
    position: relative;
    width: 100%;
    aspect-ratio: {% if section.settings.aspect_ratio == 'portrait' %} 3 / 4 {% elsif section.settings.aspect_ratio == 'original' %} auto {% else %} 1 / 1 {% endif %};
    margin-bottom: 12px;
    overflow: hidden;
    border-radius: {{ section.settings.card_border_radius }}px;
  }

  .ai-product-carousel__image-{{ section.id }} {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
    pointer-events: none; /* Prevent image drag interference */
  }

  .ai-product-carousel__card-{{ section.id }}:hover .ai-product-carousel__image-{{ section.id }} {
    transform: scale(1.05);
  }

  .ai-product-carousel__sale-badge-{{ section.id }} {
    position: absolute;
    top: {{ section.settings.sale_badge_position_top_desktop }}px;
    left: {{ section.settings.sale_badge_position_left_desktop }}px;
    background-color: {{ section.settings.sale_badge_background_color }};
    color: {{ section.settings.sale_badge_color }};
    border: 1px solid {{ section.settings.sale_badge_border_color }};
    font-family: "Poppins", sans-serif;
    padding: 5px 10px;
    font-size: {{ section.settings.sale_badge_size }}px;
    font-weight: 500;
    border-radius: 0;
    z-index: 2;
    letter-spacing: 1.5px;
  }

  .ai-product-carousel__title-{{ section.id }} {
    font-family: {{ section.settings.product_font.family }}, {{ section.settings.product_font.fallback_families }};
    font-weight: {{ section.settings.product_font.weight }};
    font-style: {{ section.settings.product_font.style }};
    font-size: {{ section.settings.desktop_product_title_size }}px;
    color: {{ section.settings.product_title_color }};
    margin: 0 0 8px 0;
    line-height: 1.3;
    {% if section.settings.product_text_center %}
      text-align: center;
    {% else %}
      text-align: left;
    {% endif %}
  }

  .ai-product-carousel__price-{{ section.id }} {
    font-family: {{ section.settings.product_font.family }}, {{ section.settings.product_font.fallback_families }};
    font-weight: {{ section.settings.product_font.weight }};
    font-style: {{ section.settings.product_font.style }};
    font-size: {{ section.settings.desktop_product_price_size }}px;
    margin: 0;
    {% if section.settings.product_text_center %}
      text-align: center;
    {% else %}
      text-align: left;
    {% endif %}
  }

  .ai-product-carousel__price-regular-{{ section.id }} {
    color: {{ section.settings.regular_price_color }};
  }

  .ai-product-carousel__price-sale-{{ section.id }} {
    color: {{ section.settings.sale_price_color }};
    margin-left: 8px;
  }

  .ai-product-carousel__price-compare-{{ section.id }} {
    text-decoration: line-through;
    color: {{ section.settings.regular_price_color }};
    opacity: 0.7;
  }

  /* Desktop: Dots */
  @media screen and (min-width: 769px) {
    .ai-product-carousel__side-arrow-{{ section.id }} {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: white;
      border: 1px solid #e0e0e0;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 10;
      transition: opacity 0.3s ease, box-shadow 0.3s ease;
      opacity: 0;
    }

    .ai-product-carousel__container-{{ section.id }}:hover .ai-product-carousel__side-arrow-{{ section.id }} {
        opacity: 1;
    }

    .ai-product-carousel__side-arrow-{{ section.id }}.left { left: -20px; }
    .ai-product-carousel__side-arrow-{{ section.id }}.right { right: -20px; }

    .ai-product-carousel__side-arrow-{{ section.id }}:not(.disabled):hover {
      box-shadow: 0 0 8px rgba(0,0,0,0.15);
    }
    
    .ai-product-carousel__side-arrow-{{ section.id }} svg {
      width: 16px;
      height: 16px;
    }
  }

  /* Mobile: Segments */
  @media screen and (max-width: 768px) {
    .ai-product-carousel__card-{{ section.id }} {
      width: calc((100% - {{ section.settings.card_spacing }}px) / {{ section.settings.mobile_columns }});
      min-width: 140px;
    }

    .ai-product-carousel__image-container-{{ section.id }} {
      aspect-ratio: {% if section.settings.mobile_aspect_ratio == 'portrait' %} 3 / 4 {% elsif section.settings.mobile_aspect_ratio == 'original' %} auto {% else %} 1 / 1 {% endif %};
    }

    .ai-product-carousel__heading-{{ section.id }} {
      font-size: {{ section.settings.heading_size | times: 0.8 }}px;
    }

    .ai-product-carousel__title-{{ section.id }} {
      font-size: {{ section.settings.mobile_product_title_size }}px;
    }

    .ai-product-carousel__price-{{ section.id }} {
      font-size: {{ section.settings.mobile_product_price_size }}px;
    }

    .ai-product-carousel__sale-badge-{{ section.id }} {
        font-size: {{ section.settings.mobile_sale_badge_size }}px;
        top: {{ section.settings.sale_badge_position_top_mobile }}px;
        left: {{ section.settings.sale_badge_position_left_mobile }}px;
    }
  }
{% endstyle %}

<div id="ProductCarousel-{{ section.id }}" class="ai-product-carousel-{{ section.id }}" {{ section.shopify_attributes }}>
  <div class="ai-product-carousel__header-{{ section.id }}">
    {% if section.settings.heading != blank %}
      <h2 class="ai-product-carousel__heading-{{ section.id }}">{{ section.settings.heading | escape }}</h2>
    {% endif %}
  </div>

  {% comment %} --- Product Selection Logic --- {% endcomment %}
  {%- assign products_to_show = "" | split: "," -%}

  {%- if section.settings.manual_products != blank and section.settings.manual_products.size > 0 -%}
    {%- assign products_to_show = section.settings.manual_products -%}
  {%- elsif section.settings.collection != blank and section.settings.collection.products.size > 0 -%}
    {%- assign products_to_show = section.settings.collection.products -%}
  {%- endif -%}

  {% if products_to_show.size > 0 %}
    <div class="ai-product-carousel__container-{{ section.id }}">
      <div class="ai-product-carousel__track-wrapper-{{ section.id }}">
        <button class="ai-product-carousel__side-arrow-{{ section.id }} left" data-side-arrow-left>
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="ai-product-carousel__track-{{ section.id }}" data-track>
          {% for product in products_to_show limit: section.settings.max_products_to_show %}
            <a href="{{ product.url }}" class="ai-product-carousel__card-{{ section.id }}">
              <div class="ai-product-carousel__image-container-{{ section.id }}">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 400 }}"
                    alt="{{ product.featured_image.alt | escape }}"
                    class="ai-product-carousel__image-{{ section.id }}"
                    loading="lazy"
                    width="400"
                    height="400"
                  >
                {% else %}
                  <div class="ai-product-carousel__image-placeholder-{{ section.id }}">
                    {{ 'product-1' | placeholder_svg_tag }}
                  </div>
                {% endif %}

                {% if product.compare_at_price > product.price %}
                  <div class="ai-product-carousel__sale-badge-{{ section.id }}">
                    {{ section.settings.sale_badge_text | escape }}
                  </div>
                {% endif %}
              </div>

              <h3 class="ai-product-carousel__title-{{ section.id }}">{{ product.title | escape }}</h3>

              <div class="ai-product-carousel__price-{{ section.id }}">
                {% if product.compare_at_price > product.price %}
                  <span class="ai-product-carousel__price-compare-{{ section.id }}">{{ product.compare_at_price | money }}</span>
                  <span class="ai-product-carousel__price-sale-{{ section.id }}">{{ product.price | money }}</span>
                {% else %}
                  <span class="ai-product-carousel__price-regular-{{ section.id }}">{{ product.price | money }}</span>
                {% endif %}
              </div>
            </a>
          {% endfor %}
        </div>
        <button class="ai-product-carousel__side-arrow-{{ section.id }} right" data-side-arrow-right>
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  {% else %}
    <div class="ai-product-carousel__empty-state-{{ section.id }}">
      <h3>No products to display</h3>
      <p>Select a collection or add products manually in the theme editor.</p>
    </div>
  {% endif %}
</div>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const carouselContainer = document.getElementById(`ProductCarousel-${sectionId}`);
    
    if (!carouselContainer) {
      return;
    }
    
    const track = carouselContainer.querySelector('[data-track]');
    const arrowLeft = carouselContainer.querySelector('[data-side-arrow-left]');
    const arrowRight = carouselContainer.querySelector('[data-side-arrow-right]');
    
    if (!track || !arrowLeft || !arrowRight) {
      return;
    }
    
    const scrollByOffset = () => {
      const firstCard = track.querySelector('.ai-product-carousel__card-' + sectionId);
      if (firstCard) {
        const cardSpacing = {{ section.settings.card_spacing }};
        return firstCard.offsetWidth + cardSpacing;
      }
      return 250; // Fallback value
    };

    arrowLeft.addEventListener('click', (event) => {
      event.preventDefault();
      track.scrollBy({ left: -scrollByOffset(), behavior: 'smooth' });
    });

    arrowRight.addEventListener('click', (event) => {
      event.preventDefault();
      track.scrollBy({ left: scrollByOffset(), behavior: 'smooth' });
    });

  })();
</script>

{% schema %}
  {
    "name": "Reusable Product Carousel",
    "tag": "section",
    "class": "product-carousel-wrapper",
    "settings": [
      {
        "type": "header",
        "content": "Content"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "TRENDING PIECES"
      },
      {
        "type": "collection",
        "id": "collection",
        "label": "Fallback Collection"
      },
      {
        "type": "product_list",
        "id": "manual_products",
        "label": "Manual Product Selection",
        "info": "Priority #1. Overrides the collection setting if products are selected here."
      },
      {
        "type": "range",
        "id": "max_products_to_show",
        "min": 4,
        "max": 50,
        "step": 1,
        "label": "Max products to show",
        "default": 12
      },
      {
        "type": "header",
        "content": "Layout & Styling"
      },
      {
        "type": "header",
        "content": "Section Padding"
      },
      {
        "type": "range",
        "id": "section_padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Top padding",
        "default": 40
      },
      {
        "type": "range",
        "id": "section_padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Bottom padding",
        "default": 40
      },
      {
        "type": "select",
        "id": "aspect_ratio",
        "label": "Image aspect ratio (Desktop)",
        "options": [
          { "value": "original", "label": "Original" },
          { "value": "square", "label": "Square (1:1)" },
          { "value": "portrait", "label": "Portrait (3:4)" }
        ],
        "default": "square"
      },
      {
        "type": "select",
        "id": "mobile_aspect_ratio",
        "label": "Image aspect ratio (Mobile)",
        "options": [
          { "value": "original", "label": "Original" },
          { "value": "square", "label": "Square (1:1)" },
          { "value": "portrait", "label": "Portrait (3:4)" }
        ],
        "default": "square"
      },
      {
        "type": "range",
        "id": "mobile_columns",
        "min": 1,
        "max": 3,
        "step": 0.1,
        "label": "Columns on mobile",
        "info": "Adjust the number of columns visible. Use decimals (e.g., 1.7) to show a part of the next item and encourage scrolling.",
        "default": 2
      },
      {
        "type": "range",
        "id": "card_spacing",
        "min": 8,
        "max": 40,
        "step": 4,
        "unit": "px",
        "label": "Card spacing",
        "default": 16
      },
      {
        "type": "range",
        "id": "card_border_radius",
        "min": 0,
        "max": 25,
        "step": 1,
        "unit": "px",
        "label": "Card border radius",
        "default": 8
      },
      {
        "type": "header",
        "content": "Typography"
      },
      {
        "type": "font_picker",
        "id": "heading_font",
        "label": "Heading font",
        "default": "bebas_neue_n4"
      },
      {
        "type": "range",
        "id": "heading_size",
        "min": 16,
        "max": 60,
        "step": 1,
        "unit": "px",
        "label": "Heading size",
        "default": 32
      },
      {
        "type": "font_picker",
        "id": "product_font",
        "label": "Product font",
        "default": "poppins_n4"
      },
      {
        "type": "range",
        "id": "desktop_product_title_size",
        "min": 12,
        "max": 30,
        "step": 1,
        "unit": "px",
        "label": "Desktop - Title size",
        "default": 16
      },
      {
        "type": "range",
        "id": "mobile_product_title_size",
        "min": 10,
        "max": 24,
        "step": 1,
        "unit": "px",
        "label": "Mobile - Title size",
        "default": 14
      },
      {
        "type": "range",
        "id": "desktop_product_price_size",
        "min": 12,
        "max": 30,
        "step": 1,
        "unit": "px",
        "label": "Desktop - Price size",
        "default": 14
      },
      {
        "type": "range",
        "id": "mobile_product_price_size",
        "min": 10,
        "max": 24,
        "step": 1,
        "unit": "px",
        "label": "Mobile - Price size",
        "default": 13
      },
      {
        "type": "checkbox",
        "id": "heading_center",
        "label": "Center heading",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "product_text_center",
        "label": "Center product text",
        "default": false
      },
      {
        "type": "header",
        "content": "Colors & Badges"
      },
      {
        "type": "color",
        "id": "heading_color",
        "label": "Heading color",
        "default": "#000000"
      },
      {
        "type": "color",
        "id": "product_title_color",
        "label": "Product title color",
        "default": "#000000"
      },
      {
        "type": "color",
        "id": "regular_price_color",
        "label": "Regular price color",
        "default": "#000000"
      },
      {
        "type": "color",
        "id": "sale_price_color",
        "label": "Sale price color",
        "default": "#ff0000"
      },
      {
        "type": "text",
        "id": "sale_badge_text",
        "label": "Sale badge text",
        "default": "ON SALE"
      },
      {
        "type": "color",
        "id": "sale_badge_color",
        "label": "Sale badge text color",
        "default": "#ff0000"
      },
      {
        "type": "color",
        "id": "sale_badge_background_color",
        "label": "Sale badge background color",
        "default": "#ffffff"
      },
      {
        "type": "color",
        "id": "sale_badge_border_color",
        "label": "Sale badge border color",
        "default": "#ff0000"
      },
      {
        "type": "range",
        "id": "sale_badge_size",
        "min": 8,
        "max": 16,
        "step": 1,
        "unit": "px",
        "label": "Sale badge size",
        "default": 12
      },
      {
        "type": "range",
        "id": "mobile_sale_badge_size",
        "min": 1,
        "max": 16,
        "step": 1,
        "unit": "px",
        "label": "Sale badge size on mobile",
        "default": 10
      },
      {
        "type": "header",
        "content": "Sale Badge Positioning"
      },
      {
        "type": "range",
        "id": "sale_badge_position_top_desktop",
        "min": 0,
        "max": 50,
        "step": 1,
        "unit": "px",
        "label": "Desktop - Top position",
        "default": 10
      },
      {
        "type": "range",
        "id": "sale_badge_position_left_desktop",
        "min": 0,
        "max": 50,
        "step": 1,
        "unit": "px",
        "label": "Desktop - Left position",
        "default": 10
      },
      {
        "type": "range",
        "id": "sale_badge_position_top_mobile",
        "min": 0,
        "max": 50,
        "step": 1,
        "unit": "px",
        "label": "Mobile - Top position",
        "default": 10
      },
      {
        "type": "range",
        "id": "sale_badge_position_left_mobile",
        "min": 0,
        "max": 50,
        "step": 1,
        "unit": "px",
        "label": "Mobile - Left position",
        "default": 10
      }
    ],
    "presets": [
      {
        "name": "Reusable Product Carousel"
      }
    ]
  }
{% endschema %}

